@page "/"
@using Model = BlazingPizza.Model
@inject HttpClient HttpClient
@inject OrderState OrderState
@inject NavigationManager NavigationManager

<div class="content">

    <!-- MAIN PIZZA GRID -->
    <div class="main">
        <h2>Blazing Pizzas</h2>

        @if (specials == null)
        {
            <p>Loading specials...</p>
        }
        else if (!specials.Any())
        {
            <p>No specials available.</p>
        }
        else
        {
            <ul class="pizza-cards">
                @foreach (var special in specials)
                {
                    <!-- Use absolute path for background image -->
                    <li style="background-image: url('@(NavigationManager.BaseUri + special.ImageUrl)');">
                        <div class="pizza-info">
                            <h3 class="title">@special.Name</h3>
                            <p>@special.Description</p>
                            <p class="price">ZWL @special.Price.ToString("0.00")</p>

                            <div class="pizza-sizes">
    @foreach (var size in new[] { "Small", "Medium", "Large" })
    {
        <button class="btn btn-size"
                @onclick="() => AddPizza(special, size)">
            Add @size
        </button>
    }
</div>
                        </div>
                    </li>
                }
            </ul>
        }
    </div>

    <!-- SIDEBAR CART -->
    <div class="sidebar">
        <h3>Your Cart</h3>

        @if (OrderState.Order.Pizzas.Count == 0)
        {
            <p>No pizzas yet.</p>
        }
        else
        {
            @foreach (var pizza in OrderState.Order.Pizzas)
            {
                <div class="cart-item">
                    <span class="title">@pizza.Size @pizza.Special?.Name</span>
                    <span class="price">ZWL @pizza.Price.ToString("0.00")</span>
                    <span class="delete-item" @onclick="() => RemovePizza(pizza)">âœ–</span>
                </div>
            }

            <div class="order-total">
                Total: ZWL @OrderState.Order.Pizzas.Sum(p => p.Price).ToString("0.00")
                <button class="btn btn-order" @onclick="GoToCheckout">Order Now</button>
            </div>
        }
    </div>
</div>

@code {
    private List<Model.PizzaSpecial> specials;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Build full URL using NavigationManager (Option 1 for Blazor Server)
            var uri = NavigationManager.BaseUri + "specials";
            specials = await HttpClient.GetFromJsonAsync<List<Model.PizzaSpecial>>(uri);
        }
        catch (Exception ex)
        {
            specials = new List<Model.PizzaSpecial>();
            Console.Error.WriteLine($"Failed to load specials: {ex.Message}");
        }
    }

    private void AddPizza(Model.PizzaSpecial special, string size)
    {
        var pizza = new Model.Pizza
        {
            Special = special,
            Size = size
        };

        OrderState.Order.Pizzas.Add(pizza);
    }

    private void RemovePizza(Model.Pizza pizza)
    {
        OrderState.Order.Pizzas.Remove(pizza);
    }

    private void GoToCheckout()
    {
        NavigationManager.NavigateTo("/checkout");
    }
}